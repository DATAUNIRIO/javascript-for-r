<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 The V8 Engine | JavaScript for R</title>
  <meta name="description" content="Invite JavaScript into your Data Science workflow." />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 The V8 Engine | JavaScript for R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Invite JavaScript into your Data Science workflow." />
  <meta name="github-repo" content="yihui/bookdown-crc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 The V8 Engine | JavaScript for R" />
  
  <meta name="twitter:description" content="Invite JavaScript into your Data Science workflow." />
  

<meta name="author" content="John Coene" />


<meta name="date" content="2020-07-04" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="node.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets/htmlwidgets.js"></script>
<script src="libs/plotly-binding/plotly.js"></script>
<script src="libs/typedarray/typedarray.min.js"></script>
<link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main/plotly-latest.min.js"></script>
<script src="libs/core-js/shim.min.js"></script>
<script src="libs/react/react.min.js"></script>
<script src="libs/react/react-dom.min.js"></script>
<script src="libs/reactwidget/react-tools.js"></script>
<script src="libs/reactable-binding/reactable.js"></script>
<script src="libs/r2d3-render/r2d3-render.js"></script>
<script src="libs/webcomponents/webcomponents.js"></script>
<script src="libs/r2d3-binding/r2d3.js"></script>
<script src="libs/d3v5/d3.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R and JavaScript</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#disclaimer"><i class="fa fa-check"></i>Disclaimer</a></li>
</ul></li>
<li class="part"><span><b>I Basics &amp; Roadmap</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#rationale"><i class="fa fa-check"></i>Rationale</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#package-development"><i class="fa fa-check"></i>Package Development</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#json"><i class="fa fa-check"></i>JSON</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#javascript"><i class="fa fa-check"></i>JavaScript</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#methods"><i class="fa fa-check"></i>Methods</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#v8"><i class="fa fa-check"></i>V8</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#htmlwidgets"><i class="fa fa-check"></i>htmlwidgets</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#shiny"><i class="fa fa-check"></i>Shiny</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#reactr"><i class="fa fa-check"></i>reactR</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#bubble"><i class="fa fa-check"></i>bubble</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#r2d3"><i class="fa fa-check"></i>r2d3</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II JavaScript for Computations</b></span></li>
<li class="chapter" data-level="2" data-path="the-v8-engine.html"><a href="the-v8-engine.html"><i class="fa fa-check"></i><b>2</b> The V8 Engine</a>
<ul>
<li class="chapter" data-level="" data-path="the-v8-engine.html"><a href="the-v8-engine.html#installation"><i class="fa fa-check"></i>Installation</a></li>
<li class="chapter" data-level="" data-path="the-v8-engine.html"><a href="the-v8-engine.html#basics"><i class="fa fa-check"></i>Basics</a></li>
<li class="chapter" data-level="" data-path="the-v8-engine.html"><a href="the-v8-engine.html#external-libraries"><i class="fa fa-check"></i>External Libraries</a></li>
<li class="chapter" data-level="" data-path="the-v8-engine.html"><a href="the-v8-engine.html#with-npm"><i class="fa fa-check"></i>With Npm</a></li>
<li class="chapter" data-level="" data-path="the-v8-engine.html"><a href="the-v8-engine.html#use-in-packages"><i class="fa fa-check"></i>Use in Packages</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="node.html"><a href="node.html"><i class="fa fa-check"></i><b>3</b> Node.js with Bubble</a>
<ul>
<li class="chapter" data-level="" data-path="node.html"><a href="node.html#basics-1"><i class="fa fa-check"></i>Basics</a></li>
<li class="chapter" data-level="" data-path="node.html"><a href="node.html#r-markdown-engine"><i class="fa fa-check"></i>R Markdown Engine</a></li>
<li class="chapter" data-level="" data-path="node.html"><a href="node.html#npm"><i class="fa fa-check"></i>Npm</a></li>
</ul></li>
<li class="part"><span><b>III Web Development with Shiny</b></span></li>
<li class="chapter" data-level="4" data-path="introduction-1.html"><a href="introduction-1.html"><i class="fa fa-check"></i><b>4</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction-1.html"><a href="introduction-1.html#static-files"><i class="fa fa-check"></i>Static Files</a></li>
<li class="chapter" data-level="" data-path="introduction-1.html"><a href="introduction-1.html#example---alerts"><i class="fa fa-check"></i>Example - Alerts</a></li>
<li class="chapter" data-level="" data-path="introduction-1.html"><a href="introduction-1.html#from-r-to-javascript"><i class="fa fa-check"></i>From R to JavaScript</a></li>
<li class="chapter" data-level="" data-path="introduction-1.html"><a href="introduction-1.html#from-javascript-to-r"><i class="fa fa-check"></i>From JavaScript to R</a></li>
<li class="chapter" data-level="" data-path="introduction-1.html"><a href="introduction-1.html#deserialise"><i class="fa fa-check"></i>Deserialise</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="a-complete-integration.html"><a href="a-complete-integration.html"><i class="fa fa-check"></i><b>5</b> A Complete Integration</a>
<ul>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#serialisation"><i class="fa fa-check"></i>Serialisation</a></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#events-callbacks"><i class="fa fa-check"></i>Events &amp; Callbacks</a></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#as-a-package"><i class="fa fa-check"></i>As a Package</a>
<ul>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#dependencies"><i class="fa fa-check"></i>Dependencies</a></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#r-code"><i class="fa fa-check"></i>R Code</a></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#javascript-code"><i class="fa fa-check"></i>JavaScript Code</a></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#input-handler"><i class="fa fa-check"></i>Input Handler</a></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#wrapping-up"><i class="fa fa-check"></i>Wrapping up</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="a-complete-integration.html"><a href="a-complete-integration.html#exercises"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="tips-tricks.html"><a href="tips-tricks.html"><i class="fa fa-check"></i><b>6</b> Tips &amp; Tricks</a>
<ul>
<li class="chapter" data-level="" data-path="tips-tricks.html"><a href="tips-tricks.html#events"><i class="fa fa-check"></i>Events</a></li>
<li class="chapter" data-level="" data-path="tips-tricks.html"><a href="tips-tricks.html#table-buttons"><i class="fa fa-check"></i>Table Buttons</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="custom-outputs.html"><a href="custom-outputs.html"><i class="fa fa-check"></i><b>7</b> Custom Outputs</a>
<ul>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#inner-workings"><i class="fa fa-check"></i>Inner-workings</a></li>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#discover-lena.js"><i class="fa fa-check"></i>Discover Lena.js</a></li>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#setup"><i class="fa fa-check"></i>Setup</a></li>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#output"><i class="fa fa-check"></i>Output</a></li>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#render"><i class="fa fa-check"></i>Render</a></li>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#javascript-binding"><i class="fa fa-check"></i>JavaScript Binding</a></li>
<li class="chapter" data-level="" data-path="custom-outputs.html"><a href="custom-outputs.html#test"><i class="fa fa-check"></i>Test</a></li>
</ul></li>
<li class="part"><span><b>IV Data Visualisation</b></span></li>
<li class="chapter" data-level="8" data-path="introduction-2.html"><a href="introduction-2.html"><i class="fa fa-check"></i><b>8</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction-2.html"><a href="introduction-2.html#candidate-libraries"><i class="fa fa-check"></i>Candidate Libraries</a>
<ul>
<li class="chapter" data-level="" data-path="introduction-2.html"><a href="introduction-2.html#plotly"><i class="fa fa-check"></i>Plotly</a></li>
<li class="chapter" data-level="" data-path="introduction-2.html"><a href="introduction-2.html#highchart.js"><i class="fa fa-check"></i>Highchart.js</a></li>
<li class="chapter" data-level="" data-path="introduction-2.html"><a href="introduction-2.html#chart.js"><i class="fa fa-check"></i>Chart.js</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction-2.html"><a href="introduction-2.html#how-it-works"><i class="fa fa-check"></i>How it works</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="your-first-widget.html"><a href="your-first-widget.html"><i class="fa fa-check"></i><b>9</b> Your First Widget</a>
<ul>
<li class="chapter" data-level="" data-path="your-first-widget.html"><a href="your-first-widget.html#the-scaffold"><i class="fa fa-check"></i>The Scaffold</a></li>
<li class="chapter" data-level="" data-path="your-first-widget.html"><a href="your-first-widget.html#the-output"><i class="fa fa-check"></i>The Output</a></li>
<li class="chapter" data-level="" data-path="your-first-widget.html"><a href="your-first-widget.html#javascript-side"><i class="fa fa-check"></i>JavaScript-side</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="a-realistic-widget.html"><a href="a-realistic-widget.html"><i class="fa fa-check"></i><b>10</b> A Realistic Widget</a>
<ul>
<li class="chapter" data-level="" data-path="a-realistic-widget.html"><a href="a-realistic-widget.html#dependency"><i class="fa fa-check"></i>Dependency</a></li>
<li class="chapter" data-level="" data-path="a-realistic-widget.html"><a href="a-realistic-widget.html#javascript-1"><i class="fa fa-check"></i>JavaScript</a></li>
<li class="chapter" data-level="" data-path="a-realistic-widget.html"><a href="a-realistic-widget.html#html-element"><i class="fa fa-check"></i>HTML Element</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="the-full-monty.html"><a href="the-full-monty.html"><i class="fa fa-check"></i><b>11</b> The Full Monty</a>
<ul>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#dependencies-1"><i class="fa fa-check"></i>Dependencies</a></li>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#javascript-2"><i class="fa fa-check"></i>JavaScript</a></li>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#working-with-data"><i class="fa fa-check"></i>Working with Data</a></li>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#transforming-data"><i class="fa fa-check"></i>Transforming Data</a>
<ul>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#in-javascript"><i class="fa fa-check"></i>In JavaScript</a></li>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#in-r"><i class="fa fa-check"></i>In R</a></li>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#pros-cons"><i class="fa fa-check"></i>Pros &amp; Cons</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="the-full-monty.html"><a href="the-full-monty.html#on-print"><i class="fa fa-check"></i>On Print</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="advanced-topics.html"><a href="advanced-topics.html"><i class="fa fa-check"></i><b>12</b> Advanced Topics</a>
<ul>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#shared-variables"><i class="fa fa-check"></i>Shared Variables</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#sizing"><i class="fa fa-check"></i>Sizing</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#sizing-policy"><i class="fa fa-check"></i>Sizing Policy</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#resizing"><i class="fa fa-check"></i>Resizing</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#pre-render-hooks-security"><i class="fa fa-check"></i>Pre Render Hooks &amp; Security</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#javascript-code-1"><i class="fa fa-check"></i>JavaScript Code</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#prepend-append-content"><i class="fa fa-check"></i>Prepend &amp; Append Content</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#dependencies-2"><i class="fa fa-check"></i>Dependencies</a></li>
<li class="chapter" data-level="" data-path="advanced-topics.html"><a href="advanced-topics.html#compatibility"><i class="fa fa-check"></i>Compatibility</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="working-with-shiny.html"><a href="working-with-shiny.html"><i class="fa fa-check"></i><b>13</b> Working with Shiny</a>
<ul>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#javascript-to-r"><i class="fa fa-check"></i>JavaScript to R</a></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#input-handler-1"><i class="fa fa-check"></i>Input Handler</a></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#r-to-javascript"><i class="fa fa-check"></i>R to JavaScript</a>
<ul>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#send-data"><i class="fa fa-check"></i>Send Data</a></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#retrieve-widget-instance"><i class="fa fa-check"></i>Retrieve Widget Instance</a></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#handle-data"><i class="fa fa-check"></i>Handle Data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#proxy-function"><i class="fa fa-check"></i>Proxy Function</a></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#example"><i class="fa fa-check"></i>Example</a></li>
<li class="chapter" data-level="" data-path="working-with-shiny.html"><a href="working-with-shiny.html#update"><i class="fa fa-check"></i>Update</a></li>
</ul></li>
<li class="part"><span><b>V Examples</b></span></li>
<li class="chapter" data-level="14" data-path="ploty.html"><a href="ploty.html"><i class="fa fa-check"></i><b>14</b> Ploty</a>
<ul>
<li class="chapter" data-level="" data-path="ploty.html"><a href="ploty.html#discover"><i class="fa fa-check"></i>Discover</a></li>
<li class="chapter" data-level="" data-path="ploty.html"><a href="ploty.html#basics-2"><i class="fa fa-check"></i>Basics</a></li>
<li class="chapter" data-level="" data-path="ploty.html"><a href="ploty.html#javascript-to-r-1"><i class="fa fa-check"></i>JavaScript to R</a></li>
<li class="chapter" data-level="" data-path="ploty.html"><a href="ploty.html#r-to-javascript-1"><i class="fa fa-check"></i>R to JavaScript</a></li>
<li class="chapter" data-level="" data-path="ploty.html"><a href="ploty.html#performance-security"><i class="fa fa-check"></i>Performance &amp; Security</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="image-classifier.html"><a href="image-classifier.html"><i class="fa fa-check"></i><b>15</b> Image Classifier</a></li>
<li class="chapter" data-level="16" data-path="math-evaluator.html"><a href="math-evaluator.html"><i class="fa fa-check"></i><b>16</b> Math Evaluator</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">JavaScript for R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="the-v8-engine" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> The V8 Engine</h1>
<p>V8 is an R interface to Google’s open source JavaScript engine of the same name, it powers Google Chrome, node.js and many other things. It is the first integration of JavaScript with R that we cover in this book. Both the V8 package and the engine it wraps are simple yet amazingly powerful.</p>
<div id="installation" class="section level2 unnumbered" number="">
<h2>Installation</h2>
<p>First install the V8 engine itself, instructions to do so are well detailed on <a href="https://github.com/jeroen/v8#installation">V8’s README</a> and below.</p>
<p>On Debian or Ubuntu use the code below from the terminal to install <a href="https://v8.dev/">libv8</a>.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="the-v8-engine.html#cb52-1"></a><span class="fu">sudo</span> apt-get install -y libv8-dev</span></code></pre></div>
<p>On Centos install v8-devel, which requires the EPEL tools.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="the-v8-engine.html#cb53-1"></a><span class="fu">sudo</span> yum install epel-release</span>
<span id="cb53-2"><a href="the-v8-engine.html#cb53-2"></a><span class="fu">sudo</span> yum install v8-devel</span></code></pre></div>
<p>On Mac OS use <a href="https://brew.sh/">Homebrew</a>.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="the-v8-engine.html#cb54-1"></a><span class="ex">brew</span> install v8</span></code></pre></div>
<p>Then install the R package from CRAN.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="the-v8-engine.html#cb55-1"></a><span class="kw">install.packages</span>(<span class="st">&quot;V8&quot;</span>)</span></code></pre></div>
</div>
<div id="basics" class="section level2 unnumbered" number="">
<h2>Basics</h2>
<p>V8 provides a reference class via <a href="https://github.com/r-lib/R6">R6</a> <span class="citation">(Chang <a href="#ref-R-R6" role="doc-biblioref">2019</a>)</span>, which pertains to object-oriented programming, hence it might look unconventional to many R users. It’s nonetheless easy to grasp. If one wants to learn more about the R6’s reference class system Hadley Wickham has a very good chapter on it in his <a href="https://adv-r.hadley.nz/r6.html">Advanced R</a> book.</p>
<p>Let’s explore the basic functionalities of the package. First, load the library and use the function <code>v8</code> to instantiate a class, this effectively returns an execution environment, every such environment is independent of another.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="the-v8-engine.html#cb56-1"></a><span class="kw">library</span>(V8)</span>
<span id="cb56-2"><a href="the-v8-engine.html#cb56-2"></a></span>
<span id="cb56-3"><a href="the-v8-engine.html#cb56-3"></a>engine &lt;-<span class="st"> </span><span class="kw">v8</span>()</span></code></pre></div>
<p>The <code>eval</code> method allows running JavaScript code from R ~and retrieve the results.~</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="the-v8-engine.html#cb57-1"></a>engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;var x = 3 + 4;&quot;</span>) <span class="co"># this is evealuated in R</span></span>
<span id="cb57-2"><a href="the-v8-engine.html#cb57-2"></a>engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;x&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;7&quot;</code></pre>
<p>Two observations on the above snippet of code. First, the variable we got back in R is a character vector when it should have been either an integer or a numeric. This is because we used the <code>eval</code> method which merely prints the output, <code>get</code> is more appropriate; it converts it to an appropriate R equivalent.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="the-v8-engine.html#cb59-1"></a><span class="co"># retrieve our previously created variable</span></span>
<span id="cb59-2"><a href="the-v8-engine.html#cb59-2"></a>(x &lt;-<span class="st"> </span>engine<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;x&quot;</span>))</span></code></pre></div>
<pre><code>## [1] 7</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="the-v8-engine.html#cb61-1"></a><span class="kw">class</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;integer&quot;</code></pre>
<p>Second, while creating a scalar with <code>eval("var x = 1;")</code> appears painless, imagine if you will the horror of having to convert a data frame to a JavaScript array via jsonlite then flatten it to character string so it can be used with the <code>eval</code> method. Horrid. Thankfully V8 comes with a method <code>assign</code>, complimentary to <code>get</code>, which declares R objects as JavaScript variables. It takes two arguments, first the name of the variable to create, second the object to assign to it.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="the-v8-engine.html#cb63-1"></a><span class="co"># assign and retrieve a data.frame</span></span>
<span id="cb63-2"><a href="the-v8-engine.html#cb63-2"></a>engine<span class="op">$</span><span class="kw">assign</span>(<span class="st">&quot;vehicles&quot;</span>, cars[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, ])</span>
<span id="cb63-3"><a href="the-v8-engine.html#cb63-3"></a>engine<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;vehicles&quot;</span>)</span></code></pre></div>
<pre><code>##   speed dist
## 1     4    2
## 2     4   10
## 3     7    4</code></pre>
<p>All of the conversion is handled by V8 internally with jsonlite as demonstrated in the previous chapter. We can confirm that the data frame was converted to a list rowwise; using <code>JSON.stringify</code> to display how the object is stored in V8.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="the-v8-engine.html#cb65-1"></a><span class="kw">cat</span>(engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;JSON.stringify(vehicles, null, 2);&quot;</span>))</span></code></pre></div>
<pre><code>## [
##   {
##     &quot;speed&quot;: 4,
##     &quot;dist&quot;: 2
##   },
##   {
##     &quot;speed&quot;: 4,
##     &quot;dist&quot;: 10
##   },
##   {
##     &quot;speed&quot;: 7,
##     &quot;dist&quot;: 4
##   }
## ]</code></pre>
<p>However the cyclical loop of 1) creating a variable in JavaScript to 2) run a function on the aforementioned object 3) get the results back in R, can be tedious. So V8 also allows calling JavaScript functions on R objects directly with the <code>call</code> method and obtain the results back in R.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="the-v8-engine.html#cb67-1"></a>engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;new Date();&quot;</span>) <span class="co"># using eval</span></span></code></pre></div>
<pre><code>## [1] &quot;Sat Jul 04 2020 21:40:36 GMT+0200 (Central European Summer Time)&quot;</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="the-v8-engine.html#cb69-1"></a>engine<span class="op">$</span><span class="kw">call</span>(<span class="st">&quot;Date&quot;</span>, <span class="kw">Sys.Date</span>()) <span class="co"># using call</span></span></code></pre></div>
<pre><code>## [1] &quot;Sat Jul 04 2020 21:40:36 GMT+0200 (Central European Summer Time)&quot;</code></pre>
<p>Finally, one can run code interactively rather than as strings by calling the console from the engine with <code>engine$console()</code> you can then exit the console by typing <code>exit</code> or hitting the <kbd>ESC</kbd> key.</p>
</div>
<div id="external-libraries" class="section level2 unnumbered" number="">
<h2>External Libraries</h2>
<p>V8 is actually quite bare in and of itself, there is for instance no functionalities built-in to read or write files from disk, it thus becomes truly interesting when you can use it JavaScript libraries. We’ll demonstrate this using <a href="https://fusejs.io/">fuse.js</a> a fuzzy-search library.</p>
<p>The very first step of integrating any external library is to look at the code, often examples, to grasp an idea of what is to be achieved from R. Below is an example from the official documentation. First, an array of two <code>books</code> is defined, this is later used to test the search. Then another array of options is defined, this should at the very least include the key(s) that should be searched, here it is set to search through the title and authors. Then, the fuse object is initialised based on the array of books and the options. Finally, the <code>search</code> method is used to retrieve all books, the title or author of which, partially match the term <code>tion</code>.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb71-1"><a href="the-v8-engine.html#cb71-1"></a><span class="co">// books to search through</span></span>
<span id="cb71-2"><a href="the-v8-engine.html#cb71-2"></a><span class="kw">var</span> books <span class="op">=</span> [<span class="op">{</span></span>
<span id="cb71-3"><a href="the-v8-engine.html#cb71-3"></a>  <span class="st">&#39;ISBN&#39;</span><span class="op">:</span> <span class="st">&#39;A&#39;</span><span class="op">,</span></span>
<span id="cb71-4"><a href="the-v8-engine.html#cb71-4"></a>  <span class="st">&#39;title&#39;</span><span class="op">:</span> <span class="st">&quot;Old Man&#39;s War&quot;</span><span class="op">,</span></span>
<span id="cb71-5"><a href="the-v8-engine.html#cb71-5"></a>  <span class="st">&#39;author&#39;</span><span class="op">:</span> <span class="st">&#39;John Scalzi&#39;</span></span>
<span id="cb71-6"><a href="the-v8-engine.html#cb71-6"></a><span class="op">},</span> <span class="op">{</span></span>
<span id="cb71-7"><a href="the-v8-engine.html#cb71-7"></a>  <span class="st">&#39;ISBN&#39;</span><span class="op">:</span> <span class="st">&#39;B&#39;</span><span class="op">,</span></span>
<span id="cb71-8"><a href="the-v8-engine.html#cb71-8"></a>  <span class="st">&#39;title&#39;</span><span class="op">:</span> <span class="st">&#39;The Lock Artist&#39;</span><span class="op">,</span></span>
<span id="cb71-9"><a href="the-v8-engine.html#cb71-9"></a>  <span class="st">&#39;author&#39;</span><span class="op">:</span> <span class="st">&#39;Steve Hamilton&#39;</span></span>
<span id="cb71-10"><a href="the-v8-engine.html#cb71-10"></a><span class="op">}</span>]</span>
<span id="cb71-11"><a href="the-v8-engine.html#cb71-11"></a></span>
<span id="cb71-12"><a href="the-v8-engine.html#cb71-12"></a><span class="kw">const</span> options <span class="op">=</span> <span class="op">{</span></span>
<span id="cb71-13"><a href="the-v8-engine.html#cb71-13"></a>  <span class="co">// Search in `author` and in `title` array</span></span>
<span id="cb71-14"><a href="the-v8-engine.html#cb71-14"></a>  <span class="dt">keys</span><span class="op">:</span> [<span class="st">&#39;author&#39;</span><span class="op">,</span> <span class="st">&#39;title&#39;</span>]</span>
<span id="cb71-15"><a href="the-v8-engine.html#cb71-15"></a><span class="op">}</span></span>
<span id="cb71-16"><a href="the-v8-engine.html#cb71-16"></a></span>
<span id="cb71-17"><a href="the-v8-engine.html#cb71-17"></a><span class="co">// initialise</span></span>
<span id="cb71-18"><a href="the-v8-engine.html#cb71-18"></a><span class="kw">const</span> fuse <span class="op">=</span> <span class="kw">new</span> <span class="at">Fuse</span>(list<span class="op">,</span> options)</span>
<span id="cb71-19"><a href="the-v8-engine.html#cb71-19"></a></span>
<span id="cb71-20"><a href="the-v8-engine.html#cb71-20"></a><span class="co">// search &#39;tion&#39; in authors and titles</span></span>
<span id="cb71-21"><a href="the-v8-engine.html#cb71-21"></a><span class="kw">const</span> result <span class="op">=</span> <span class="va">fuse</span>.<span class="at">search</span>(<span class="st">&#39;tion&#39;</span>)</span></code></pre></div>
<p>With some understanding of what is to be reproduced in R we can import the library with the <code>source</code> method which takes a <code>file</code> argument that will accept a path or URL to a JavaScript file to source, below we use the handy CDN (Content Delivery Network) so as to avoid downloading a file.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="the-v8-engine.html#cb72-1"></a>engine<span class="op">$</span><span class="kw">source</span>(<span class="st">&quot;https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.6/fuse.min.js&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;true&quot;</code></pre>
<p>You can think of it as using the <code>script</code> tag in HTML to source (<code>src</code>) said file from disk or CDN.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb74-1"><a href="the-v8-engine.html#cb74-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb74-2"><a href="the-v8-engine.html#cb74-2"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb74-3"><a href="the-v8-engine.html#cb74-3"></a>    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&#39;https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.6/fuse.min.js&#39;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb74-4"><a href="the-v8-engine.html#cb74-4"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb74-5"><a href="the-v8-engine.html#cb74-5"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb74-6"><a href="the-v8-engine.html#cb74-6"></a>    <span class="kw">&lt;p&gt;</span>Content<span class="kw">&lt;/p&gt;</span></span>
<span id="cb74-7"><a href="the-v8-engine.html#cb74-7"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb74-8"><a href="the-v8-engine.html#cb74-8"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>With the library imported its functions can accessed via V8. We’ll replicate an example from fuse.js official website where it executes a search on an object that contains books and looks like JSON below.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb75-1"><a href="the-v8-engine.html#cb75-1"></a><span class="kw">var</span> books <span class="op">=</span> [<span class="op">{</span></span>
<span id="cb75-2"><a href="the-v8-engine.html#cb75-2"></a>  <span class="st">&#39;ISBN&#39;</span><span class="op">:</span> <span class="st">&#39;A&#39;</span><span class="op">,</span></span>
<span id="cb75-3"><a href="the-v8-engine.html#cb75-3"></a>  <span class="st">&#39;title&#39;</span><span class="op">:</span> <span class="st">&quot;Old Man&#39;s War&quot;</span><span class="op">,</span></span>
<span id="cb75-4"><a href="the-v8-engine.html#cb75-4"></a>  <span class="st">&#39;author&#39;</span><span class="op">:</span> <span class="st">&#39;John Scalzi&#39;</span></span>
<span id="cb75-5"><a href="the-v8-engine.html#cb75-5"></a><span class="op">},</span> <span class="op">{</span></span>
<span id="cb75-6"><a href="the-v8-engine.html#cb75-6"></a>  <span class="st">&#39;ISBN&#39;</span><span class="op">:</span> <span class="st">&#39;B&#39;</span><span class="op">,</span></span>
<span id="cb75-7"><a href="the-v8-engine.html#cb75-7"></a>  <span class="st">&#39;title&#39;</span><span class="op">:</span> <span class="st">&#39;The Lock Artist&#39;</span><span class="op">,</span></span>
<span id="cb75-8"><a href="the-v8-engine.html#cb75-8"></a>  <span class="st">&#39;author&#39;</span><span class="op">:</span> <span class="st">&#39;Steve Hamilton&#39;</span></span>
<span id="cb75-9"><a href="the-v8-engine.html#cb75-9"></a><span class="op">}</span>]</span></code></pre></div>
<p>This can be easily created, as we’ve already seen this is just how V8 creates data frames. We define a data.frame of books that looks similar and load it into our engine.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="the-v8-engine.html#cb76-1"></a>books &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb76-2"><a href="the-v8-engine.html#cb76-2"></a>  <span class="dt">title =</span> <span class="kw">c</span>(</span>
<span id="cb76-3"><a href="the-v8-engine.html#cb76-3"></a>    <span class="st">&quot;Rights of Man&quot;</span>,</span>
<span id="cb76-4"><a href="the-v8-engine.html#cb76-4"></a>    <span class="st">&quot;Black Swan&quot;</span>,</span>
<span id="cb76-5"><a href="the-v8-engine.html#cb76-5"></a>    <span class="st">&quot;Common Sense&quot;</span>,</span>
<span id="cb76-6"><a href="the-v8-engine.html#cb76-6"></a>    <span class="st">&quot;Sense and Sensibility&quot;</span></span>
<span id="cb76-7"><a href="the-v8-engine.html#cb76-7"></a>  ),</span>
<span id="cb76-8"><a href="the-v8-engine.html#cb76-8"></a>  <span class="dt">id =</span> <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>, <span class="st">&quot;d&quot;</span>)</span>
<span id="cb76-9"><a href="the-v8-engine.html#cb76-9"></a>)</span>
<span id="cb76-10"><a href="the-v8-engine.html#cb76-10"></a></span>
<span id="cb76-11"><a href="the-v8-engine.html#cb76-11"></a>engine<span class="op">$</span><span class="kw">assign</span>(<span class="st">&quot;books&quot;</span>, books)</span></code></pre></div>
<p>Then again we can make sure that the data.frame was turned into a rowwise JSON object.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="the-v8-engine.html#cb77-1"></a><span class="kw">cat</span>(engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;JSON.stringify(books, null, 2);&quot;</span>))</span></code></pre></div>
<pre><code>## [
##   {
##     &quot;title&quot;: &quot;Rights of Man&quot;,
##     &quot;id&quot;: &quot;a&quot;
##   },
##   {
##     &quot;title&quot;: &quot;Black Swan&quot;,
##     &quot;id&quot;: &quot;b&quot;
##   },
##   {
##     &quot;title&quot;: &quot;Common Sense&quot;,
##     &quot;id&quot;: &quot;c&quot;
##   },
##   {
##     &quot;title&quot;: &quot;Sense and Sensibility&quot;,
##     &quot;id&quot;: &quot;d&quot;
##   }
## ]</code></pre>
<p>Now we can define options for our search, we don’t get into the details of fuse.js here as this is not the purpose of this book, you can read more about the options in the <a href="https://fusejs.io/#Examples">examples section</a> of the site. We can mimic the format of the JSON options shown on the website with a simple list and assign that to our engine. If this confuses read the <a href="intro.html#json">JSON section of the introduction</a>.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb79-1"><a href="the-v8-engine.html#cb79-1"></a><span class="co">// JavaScript</span></span>
<span id="cb79-2"><a href="the-v8-engine.html#cb79-2"></a><span class="kw">var</span> options <span class="op">=</span> <span class="op">{</span></span>
<span id="cb79-3"><a href="the-v8-engine.html#cb79-3"></a>  <span class="dt">keys</span><span class="op">:</span> [<span class="st">&#39;title&#39;</span>]<span class="op">,</span></span>
<span id="cb79-4"><a href="the-v8-engine.html#cb79-4"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;id&#39;</span></span>
<span id="cb79-5"><a href="the-v8-engine.html#cb79-5"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="the-v8-engine.html#cb80-1"></a><span class="co"># R</span></span>
<span id="cb80-2"><a href="the-v8-engine.html#cb80-2"></a>options &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb80-3"><a href="the-v8-engine.html#cb80-3"></a>  <span class="dt">keys =</span> <span class="kw">list</span>(<span class="st">&quot;title&quot;</span>),</span>
<span id="cb80-4"><a href="the-v8-engine.html#cb80-4"></a>  <span class="dt">id =</span> <span class="st">&quot;id&quot;</span></span>
<span id="cb80-5"><a href="the-v8-engine.html#cb80-5"></a>)</span>
<span id="cb80-6"><a href="the-v8-engine.html#cb80-6"></a></span>
<span id="cb80-7"><a href="the-v8-engine.html#cb80-7"></a>engine<span class="op">$</span><span class="kw">assign</span>(<span class="st">&quot;options&quot;</span>, options)</span></code></pre></div>
<p>Then we can finish the second step of the online examples, instantiate a fuse.js object with our books and options objects then make a simple search, we assign the results of the search to an object which we then retrieve in R with <code>get</code>.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="the-v8-engine.html#cb81-1"></a>engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;var fuse = new Fuse(books, options)&quot;</span>)</span>
<span id="cb81-2"><a href="the-v8-engine.html#cb81-2"></a>engine<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;var results = fuse.search(&#39;sense&#39;)&quot;</span>)</span>
<span id="cb81-3"><a href="the-v8-engine.html#cb81-3"></a>engine<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;results&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;d&quot; &quot;c&quot;</code></pre>
<p>A search for “sense” returns a vector of ids where the term “sense” was found; <code>c</code> and <code>d</code> or the books Common Sense, Sense and Sensibility. We could perhaps make that last code simpler using the <code>call</code> method.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="the-v8-engine.html#cb83-1"></a>engine<span class="op">$</span><span class="kw">call</span>(<span class="st">&quot;fuse.search&quot;</span>, <span class="st">&quot;sense&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;d&quot; &quot;c&quot;</code></pre>
</div>
<div id="with-npm" class="section level2 unnumbered" number="">
<h2>With Npm</h2>
<p>We can also use <a href="https://www.npmjs.com/">npm</a> packages, though not all will work. Npm is Node’s Package Manager, or in a sense Node’s equivalent of CRAN.</p>
<p>To use npm packages we need <a href="http://browserify.org/">browserify</a>, a node library to bundle all dependencies of an npm package into a single, file which we can subsequently source in V8. Browserify is itself an npm package and there requires node and npm installed.</p>
<p>You can install browserify globally with the following command from the terminal.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="the-v8-engine.html#cb85-1"></a><span class="ex">npm</span> install -g browserify</span></code></pre></div>
<p>We can now browserify an npm package. To demonstrate we will use <a href="https://github.com/zeit/ms">ms</a> which converts various time formats to milliseconds. First we install the npm package.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="the-v8-engine.html#cb86-1"></a><span class="ex">npm</span> install ms</span></code></pre></div>
<p>Then we browserify it. From the terminal, the first line creates a file called <code>in.js</code> which contains <code>global.ms = require('ms');</code> we then call browserify on that file specifying <code>ms.js</code> as output file.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="the-v8-engine.html#cb87-1"></a><span class="bu">echo</span> <span class="st">&quot;global.ms = require(&#39;ms&#39;);&quot;</span> <span class="op">&gt;</span> in.js</span>
<span id="cb87-2"><a href="the-v8-engine.html#cb87-2"></a><span class="ex">browserify</span> in.js -o ms.js</span></code></pre></div>
<p>We can now source <code>ms.js</code> with v8, before we do so we ought to look at example code to see what has to be reproduced using V8. Luckily the library is very straightforward: it includes a single function for all conversions, e.g.: <code>ms('2 days')</code> to convert 2 days in milliseconds.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="the-v8-engine.html#cb88-1"></a><span class="kw">library</span>(V8)</span>
<span id="cb88-2"><a href="the-v8-engine.html#cb88-2"></a></span>
<span id="cb88-3"><a href="the-v8-engine.html#cb88-3"></a>ms &lt;-<span class="st"> </span><span class="kw">v8</span>()</span>
<span id="cb88-4"><a href="the-v8-engine.html#cb88-4"></a>ms<span class="op">$</span><span class="kw">source</span>(<span class="st">&quot;ms.js&quot;</span>)</span></code></pre></div>
<p>Then using the library simply consists of using <code>eval</code> or preferably <code>call</code> (for cleaner code and data interpretation to R).</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="the-v8-engine.html#cb89-1"></a>ms<span class="op">$</span><span class="kw">eval</span>(<span class="st">&quot;ms(&#39;2 days&#39;)&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;172800000&quot;</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="the-v8-engine.html#cb91-1"></a>ms<span class="op">$</span><span class="kw">call</span>(<span class="st">&quot;ms&quot;</span>, <span class="st">&quot;1y&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 3.156e+10</code></pre>
</div>
<div id="use-in-packages" class="section level2 unnumbered" number="">
<h2>Use in Packages</h2>
<p>In this section we detail how one should go about using V8 in an R package, if you are not familiar with package development you can skip ahead.</p>
<p>Create a package however you usually do, using usethis, devtools or the RStudio IDE interface. Below we create a package called “ms” that will hold functionalities we explored in the previous section on npm packages.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="the-v8-engine.html#cb93-1"></a>usethis<span class="op">::</span><span class="kw">create_package</span>(<span class="st">&#39;ms&#39;</span>)</span></code></pre></div>
<p>The package is going to rely on V8 so it needs to be added under <code>Imports</code> in the <code>DESCRIPTION</code> file, then again this can be done with usethis as shown below.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="the-v8-engine.html#cb94-1"></a><span class="co"># add V8 to DESCRIPTION</span></span>
<span id="cb94-2"><a href="the-v8-engine.html#cb94-2"></a>usethis<span class="op">::</span><span class="kw">use_package</span>(<span class="st">&quot;V8&quot;</span>)</span></code></pre></div>
<p>The package should also include the external library <code>ms.js</code> browserified from the npm package which should be placed it in the <code>inst</code> directory. Create it and place the <code>ms.js</code> file within the latter.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="the-v8-engine.html#cb95-1"></a><span class="kw">dir.create</span>(<span class="st">&quot;inst&quot;</span>)</span></code></pre></div>
<p>As explored, the core the V8 package is the execution environment(s) that are spawned using the <code>v8</code> function. One could perhaps provide a function that returns the class created by <code>v8</code> but it would not be convenient. This function would need to be called explicitly by the users of the package and the output of it would need to be passed to every subsequent functions. Thankfully there is a better way.</p>
<p>Instead we can use the function <code>.onLoad</code>, to create the execution environment and import the dependency when the package is loaded by the user.</p>
<p>You can read more about this function Hadley Wickham’s <a href="http://r-pkgs.had.co.nz/r.html">Advanced R book</a>. The Python integration of R, <a href="https://rstudio.github.io/reticulate">reticulate</a> <span class="citation">(Ushey, Allaire, and Tang <a href="#ref-R-reticulate" role="doc-biblioref">2020</a>)</span> also advises using <a href="https://rstudio.github.io/reticulate/articles/package.html">this method</a> to import modules too. We often see this function placed in a <code>zzz.R</code> file.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="the-v8-engine.html#cb96-1"></a><span class="co"># zzz.R</span></span>
<span id="cb96-2"><a href="the-v8-engine.html#cb96-2"></a>ms &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb96-3"><a href="the-v8-engine.html#cb96-3"></a></span>
<span id="cb96-4"><a href="the-v8-engine.html#cb96-4"></a>.onLoad &lt;-<span class="st"> </span><span class="cf">function</span>(libname, pkgname){</span>
<span id="cb96-5"><a href="the-v8-engine.html#cb96-5"></a>  ms &lt;&lt;-<span class="st"> </span><span class="kw">v8</span>()</span>
<span id="cb96-6"><a href="the-v8-engine.html#cb96-6"></a>}</span></code></pre></div>
<p>At this stage one should obtain a directory structure similar to the tree below.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="the-v8-engine.html#cb97-1"></a><span class="ex">.</span></span>
<span id="cb97-2"><a href="the-v8-engine.html#cb97-2"></a>├── <span class="ex">DESCRIPTION</span></span>
<span id="cb97-3"><a href="the-v8-engine.html#cb97-3"></a>├── <span class="ex">NAMESPACE</span></span>
<span id="cb97-4"><a href="the-v8-engine.html#cb97-4"></a>├── <span class="ex">R</span></span>
<span id="cb97-5"><a href="the-v8-engine.html#cb97-5"></a>│   └── <span class="ex">zzz.R</span></span>
<span id="cb97-6"><a href="the-v8-engine.html#cb97-6"></a>└── <span class="ex">inst</span></span>
<span id="cb97-7"><a href="the-v8-engine.html#cb97-7"></a>    └── <span class="ex">ms.js</span></span></code></pre></div>
<p>Now the dependency can be sourced in the <code>.onLoad</code> function. We can locate the files in the <code>inst</code> directory with the <code>system.file</code> function.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="the-v8-engine.html#cb98-1"></a><span class="co"># zzz.R</span></span>
<span id="cb98-2"><a href="the-v8-engine.html#cb98-2"></a>ms &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb98-3"><a href="the-v8-engine.html#cb98-3"></a></span>
<span id="cb98-4"><a href="the-v8-engine.html#cb98-4"></a>.onLoad &lt;-<span class="st"> </span><span class="cf">function</span>(libname, pkgname){</span>
<span id="cb98-5"><a href="the-v8-engine.html#cb98-5"></a>  ms &lt;&lt;-<span class="st"> </span>V8<span class="op">::</span><span class="kw">v8</span>()</span>
<span id="cb98-6"><a href="the-v8-engine.html#cb98-6"></a></span>
<span id="cb98-7"><a href="the-v8-engine.html#cb98-7"></a>  <span class="co"># locate dependency file</span></span>
<span id="cb98-8"><a href="the-v8-engine.html#cb98-8"></a>  dep &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;ms.js&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;ms&quot;</span>)</span>
<span id="cb98-9"><a href="the-v8-engine.html#cb98-9"></a>  ms<span class="op">$</span><span class="kw">source</span>(dep)</span>
<span id="cb98-10"><a href="the-v8-engine.html#cb98-10"></a>}</span></code></pre></div>
<p>We can then create a <code>to_ms</code> function, it will have access the <code>ms</code> object we instantiated in <code>.onLoad</code>.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="the-v8-engine.html#cb99-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb99-2"><a href="the-v8-engine.html#cb99-2"></a>to_ms &lt;-<span class="st"> </span><span class="cf">function</span>(string){</span>
<span id="cb99-3"><a href="the-v8-engine.html#cb99-3"></a>  ms<span class="op">$</span><span class="kw">call</span>(<span class="st">&quot;ms&quot;</span>, string)</span>
<span id="cb99-4"><a href="the-v8-engine.html#cb99-4"></a>}</span></code></pre></div>
<p>After running <code>devtools::document()</code> and <code>devtools::load_all()</code> the package can be used.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="the-v8-engine.html#cb100-1"></a>ms<span class="op">::</span><span class="kw">to_ms</span>(<span class="st">&quot;2 days&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 172800000</code></pre>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-R-R6">
<p>Chang, Winston. 2019. <em>R6: Encapsulated Classes with Reference Semantics</em>. <a href="https://CRAN.R-project.org/package=R6">https://CRAN.R-project.org/package=R6</a>.</p>
</div>
<div id="ref-R-reticulate">
<p>Ushey, Kevin, JJ Allaire, and Yuan Tang. 2020. <em>Reticulate: Interface to ’Python’</em>. <a href="https://CRAN.R-project.org/package=reticulate">https://CRAN.R-project.org/package=reticulate</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="node.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/JohnCoene/r-and-javascript/edit/master/02-v8.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": {},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
